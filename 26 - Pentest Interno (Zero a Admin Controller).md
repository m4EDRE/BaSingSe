
# Pentest Interno - 0 a Domain Admin

Nesse módulo reservamos um espaço para descrever de forma modular um passo a passo sobre um exemplo de como ao realizar um pentest ir do step 0 até Domain Admin de um sistema.

# 1. Identificando escopo da rede (RECON)

*No exemplo que estamos trabalhando com foi solicitado um pentest interno e local ao sistema, focando apenas no hosts do domínio `orionscorp`

*Como `dica`vale a pena demais abrir um `notepad`no começo do pentest e ir anotando as informações interessantes conforme for prosseguindo…

1. Começar com o clássico fazendo uma revisão nas portas abertas da rede alvo, também sempre vale a pena fazer algo mais focado para SMB pois ele possibilita `PSEXEC`e `Eternals…`
    
    - `nmap -v -sS —top-ports 100 -Pn <rede/máscara>`
    - `nmap -v -sS -p 445 -Pn -oG <rede/máscara> hostssmb.txt`
2. Encontrando itens com SMB vale a pena começar a usar o canivete suiço crackmapexec para fazer a enumeração do serviço, em conjunto com o que aprendemos anteriormente no módulo de Enumeration….
    
    - `crackmapexec smb <arquivo com os IPs alvos>`
    - Com isso muitas vezes teremos noção de quais hosts são referentes a quais domínios, e assim poderemos focar
3. Agora tendo confirmado quais hosts são de cada domínio podemos focar apenas nos hosts do dominio **orionscorp** e com isso fazer o Enumeration completo deles com **NMAP**
    
    `nmap -v -sS —p- -Pn -O <host da onionscorp>`
    
    - Da pra saber quem é o AD pelas portas abertas
    - Da pra saber nome dos servers com: `host <IP> <IP do DNS server da rede>`
4. Aplica processo completo de Enumeration + Exploração de Vulns nos alvos
    
    - Foco aqui é pegar uma shell, precisamos de uma na rede!
5. Como último passo da RECON podemos utilizar o responder para capturar hashs na rede, e dessa forma obtermos credenciais de vários users do sistema.
    
    - `responder -I <interface> -Prv`
    - Caso você não consiga a shell de uma máquina no passo 4, utilize o seu host conectado a rede para rodar o programa.
    
    ### Resumo do passo a passo:
    
    ```bash
    1. NMAP na rede alvo
    2. Crackmapexec para capturar SMB com os hosts que tem SMB aberto
    3. Identificar hosts do domínio alvo 
    4. Aplicar Enumeration + Exploração
    5. Tentativa de pegar a shell para Responder, ou Responder via host do atacante
    ```
    


----




# 2. Validando credenciais encontradas

*No passo 1 fomos capazes de conseguir credenciais do sistema com o `responder` , após quebra-las com os processos normais de quebra que vimos nos módulos sobre quebra de hash precisamos **validar essas credenciais…**

### Passo a passo para validação de credenciais

1. Enumeração smbclient
    
    - `smbclient -L \\\\<IP alvo> -U <user> -W <domínio>`
    - *Você pode por`//<IP>/<pasta>` se tiver achado uma pasta específica
    - Se você conseguir listar use o comando sem o `-L` para poder se conectar nos dir
        - `smbclient [//<IP>/](<https://172.16.1.253/C$>)<dir> -U <user> -W <dominio>`
2. Utilize o crackmapexec novamente dessa vez com credenciais para que ele arregace o alvo…
    
    - `crackmapexec smb <arquivo com hosts> -d <dominio> -u <user> -p '<senha>’`
3. Utilizar códigos `PSEXEC` no metasploit com as credenciais encontradas. Esses códigos podem ter alta chance de funcionarem com as credenciais corretas..
    
    - msfdb console
    - `use /exploit/windows/smb/psexec ou outro`
    - `set {Tudo que precisar}`
    - Revisar se o show payloads ta certo e tentar com outros show targets…
    - Aqui é ideal usar usuários com mais privilégios, isso é, conseguem rodar comandos ou tem acesso a mais pastas smb em outros hosts
4. Vale a pena tentar rodar uma conexão ao server também utilizando `xfreerdp`para acesso remoto
    
    `xfreerdp3 /v:IP_OU_HOSTNAME /u:USUARIO /p:SENHA`
    



----




# 3. Enumerando contas do AD

*No último módulo obtivemos e validamos várias credenciais, tanto de usuários com alto e baixo privilégio. Dessa forma o próximo passo agora é realizar ataques no server AD para obter outras contas do ambiente.

Para isso:

1. Usaremos rpcclient no servidor AD com as credenciais que obtemos
    - `rpcclient -W <dominio> -U <user> <IPs>`

*Comandos para explorar RPCCLIENT:

- `enumdomusers` : Traz RID dos users também
- `getusername`
- `queryuser <RID do user>`
- `enumdomgroups` : Mostra grupos como o de Admins
- `querygroup <RID do grupo>`
- `querygroupmem` : Users dentro de um grupo
- `setuserinfo2 <USER> 23 '<SENHA>’` : TROCA SENHA DE USERS

1. Feito o processo 1 bem feito agora teremos diversas informações sobre o ambiente, inclusive quem são os admins da rede (users dentro do grupo de admin)
2. Com esses users agora temos informações o bastante para fazer um **ataque focado** no ambiente, visando obter as credenciais do admin do domínio e assim acessar o AD




----




# 4. Conseguindo Domain Admin

*Após coletarmos todas as informações vistas nos módulos passados agora somos capazes de fazer um ataque focado ao Domain Admin do sistema. A seguir revisaremos como fazer isso:

### Passo a passo utilizado

1. Revisar qual o username encontrado do domain admin, esse username foi visto quando listamos os users no `enumdomgroups`do RPCCLIENT módulo passado
2. Utilizando as credenciais **não-admin** encontradas no módulo passado faça um impact-secretdump no servidor AD
    - `impact-secretdump <dominio>/user:’<senha>’@<IP>`
    - Usuário deve ter permissões de execução
3. Utiliza `hashdump`na máquina do usuário que você já tem acesso, pode ter a senha do domain admin registrada nesse host que você já tem acesso
    - Com o meterpreter podemos também testar por alternativas como:
    - `load kiwi`
    - `load mimikatz`
4. Busca por senhas e usuários no `cache` da máquina do usuário que você já tem as credenciais, isso pode ajudar a conseguir a senha do domain admin pra acessar o AD
    - Buscar esse processo no módulo de quebra de hashes
5. Com a senha do domain admin, não se esqueça de utilizar a internet, hashid e o que mais puder para descobrir o tipo do hash.
6. Teste as credenciais de domain admin
    - `smbclient -L \\\\<IP> -U <username> -W <dominio>`
    - senha





----






# 5. Obtendo acesso ao servidor AD (Conclusão)

*Agora com as credenciais do domain admin, faremos acesso ao servidor AD para termos gerência completa do ambiente.

### Passo a passo para explorar servidor AD

1. Utilizaremos o crackmapexec (Canivete suiço do SMB) para debulhar o servidor AD com as credenciais que temos de Admin
    - `crackmapexec smb <IP> -u <user> -p ‘<senha>’ -x ‘comando’`
2. Seguindo com a exploração, os próximos passos devem ser a tentativa de controle remoto com as credenciais usando o `xfreerdp` e explorando vulns no metasploit como a `psexec`
    - `psexec` com as credenciais corretas fica mt efetivo
    - vale a pena revisar o que ele faz
3. Uma vez validadas as conexões ao servidor AD podemos utilizar o impacket-secretdump para explorar o servidor AD e encontrarmos ainda mais credenciais.
    - `impacket-secretdump <dominio>/<user>:’<senha>’@<IP>`

### Conclusão sobre a exploração desde o 0 até Domain Admin

- Importante ressaltar os pontos abaixo:
    - Talvez seja necessário habilitar o RDP no servidor AD, para isso podemos usar o crackmapexec que importa comandos….
        
        `crackmapexec smb <IP> -u <user> -p ‘<senha>’ -M rdp (—options/-o ACTION=enable)`
        
        Utiliza o xfreerdp dai depois
        
    - Caso também em algum momento da exploração você se deparar com hashes que estejam difíceis para quebrar, utilize a técnica de **Pass the Hash** para tentar conexões importantes nos hosts
        
    - Com isso completamos todo o processo para ir do 0 até dominar todo o ambiente em um pentest interno